name: Check Python with Pylint (PEP8)

on: 
  push:
  pull_request:
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies for linting
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libasound2-dev \
          python3-dbus python3-gi \
          gir1.2-glib-2.0 \
          libgirepository1.0-dev

    - name: Install Python dependencies for linting
      run: |
        python -m pip install --upgrade pip
        pip install pylint
        pip install smbus2 rpi-lgpio concurrent_log_handler requests \
                    nmcli vcgencmd watchdog python-mpd2 pydantic \
                    fastapi JinJa2 uvicorn python-multipart
        pip install pyalsaaudio --use-pep517

    - name: Run pylint
      # Disable immediate exit on error
      # Use .pylintrc 
      # Prevent MPDClient no-member errors, as they are false positives
      # Fail on fatal(1) + error(2) + warning(4) + usage(32), continue on refactor(8) and convention(16)
      run: |
        set +e     
        pylint $(git ls-files '*.py') \
        --rcfile=.github/workflows/.pylintrc \
        --generated-members=self.client,mpd.client \
        --output=pylint_result.txt
        status=$?
        echo "Raw pylint exit code: $status"
        masked=$((status & 39))
        echo "Masked exit code (fatal, error, warning, usage): $masked"
        exit $masked
      shell: bash

    - name: Upload pylint result
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pylint_result.txt
        path: pylint_result.txt
