<!DOCTYPE html>
<html lang="nl">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<link rel="stylesheet" href="../static/css/fontawesome.min.css" />
		<link rel="stylesheet" href="../static/css/regular.min.css" />
		<link rel="stylesheet" href="../static/css/oradio3.css" />
		<link rel="stylesheet" href="../static/css/playlists.css" />

		<title>Oradio speellijsten</title>

<style>
/* Make drop down icon stand out more */
.custom-select {
	width: 100%;
	position: relative;
	display: inline-block;
	cursor: pointer;
}
.custom-select input {
	margin-bottom: 0;
}
.custom-select .custom-icon {
	position: absolute;
	right: 10px;
	font-size: 20px;
	transform: translateY(30%);
	pointer-events: none; /* Ensures clicking is not blocked */
}

.options {
	border: 1px solid var(--oradio-border);
	display: none;
	position: absolute;
	top: 100%;
	left: 0;
	right: 0;
	background-color: var(--oradio-list);
	z-index: 10;
	max-height: 200px;
	overflow-y: auto;
}

.options div {
	padding: 8px;
	cursor: pointer;
}

.options div:hover {
	background-color: var(--oradio-select);
}

.playlists_grid {
	display: grid;
	margin-bottom: 20px;
	grid-template-columns: 2.5fr 0.5fr 0.5fr;
}

.songs_grid {
	display: grid;
	grid-template-columns: 2.5fr 0.5;
}

.my-button {
	background-color: transparent;
	background-size: cover; /* Laat de afbeelding het hele oppervlak bedekken */
	cursor: pointer;           /* Muisaanwijzer */
}

.my-button:hover {
	background-color: transparent;
	filter: brightness(80%); /* Lager dan 100% = donkerder */
}

.save-button {
	background-image: url('../static/save.png'); /* Zorg dat deze PNG in dezelfde map staat */
	width: 40px;
	height: 40px;
	justify-self: end;
}
.save-button2 {
	background-image: url('../static/save.png'); /* Zorg dat deze PNG in dezelfde map staat */
	width: 20px;
	height: 20px;
	justify-self: end;
}

.delete-button {
	background-image: url('../static/delete.png'); /* Zorg dat deze PNG in dezelfde map staat */
	width: 40px;
	height: 40px;
	justify-self: end;
}
.delete-button2 {
	background-image: url('../static/delete.png'); /* Zorg dat deze PNG in dezelfde map staat */
	width: 20px;
	height: 20px;
	justify-self: end;
}
.songs {
	display: none;
}
</style>

	</head>
	<body>
		{% include "menu.html" %}
		<div class="container">

			<!-- Show Oradio logo -->
			<img src="../static/logo.png" class="logo" />

			<!-- Set presets -->
			<form id="form_presets" method="POST">
				<!-- identifier used by server: do not change or remove -->
				<input type="hidden" name="action" value="presets" />
				<h1 id="presets">Speellijst aan knop koppelen</h1>
				{% for item in presets %}
					<div class="presets-grid">
						<div class="preset-label">
							Voorkeur {{ loop.index }}:
						</div>
						<div class="custom-select" data-options='{{ folders|tojson|safe }}'>
							{% set index = ["preset", loop.index]|join %}
							{% for folder in folders %}
								{% if presets[index] == folder %}
									<input type="text" id="{{ index }}" name="{{ index }} "value="{{ folder }}" readonly placeholder="-- Kies een speellijst --">
								{% endif %}
							{% endfor %}
							<span class="custom-icon">&#x25BC;</span> <!-- ▼ icon -->
							<div class="options"></div>
						</div>
					</div>
				{% endfor %}
				<div id="presets_notification" class="notification">
					<!-- Will be filled by Javascript submitCredentials() -->
				</div>
			</form>

			<!-- Custom playlist -->
			<form id="form_playlist" method="POST">
				<!-- identifier used by server: do not change or remove -->
				<input type="hidden" name="action" value="playlist" />
				<h1 id="playlists">Speellijsten beheren</h1>
				<div class="playlists_grid">
					<div class="custom-select" data-options='{{ folders|tojson|safe }}'>

						<input type="text" id="playlist" name="playlist" value="{{ playlist }}" placeholder="-- Kies een speellijst --">
						<span class="custom-icon">&#x25BC;</span> <!-- ▼ icon -->
						<div id="options" class="options"></div>

					</div>
					<button class="my-button save-button" title="Bewaren" onclick="savePlaylist()"></button>
					<button class="my-button delete-button" title="Verwijderen" onclick="deletePlaylist()"></button>
				</div>
				<div id="playlist_notification" class="notification">
					<!-- Will be filled by Javascript submitCredentials() -->
				</div>
<!--
			</form>
-->
				<!-- Show songs in a playlist -->
				{% if playlist_songs %}
				<div class="file-list">
					<ul id="songs1">
					{% for song in playlist_songs %}
						<div style="display: grid; grid-template-columns: auto auto">
							<li id="{{ song["file"] }}">{{ song["artist"] }} - {{ song["title"] }}</li>
							<!-- Hide/show by Javascript depending on playlist -->
							<button class="songs my-button delete-button2" title="Verwijderen" onclick="removeSong({{ song }})"></button>
						</div>
					{% endfor %}
					</ul>
				</div>
				{% endif %}

				<!-- Search songs by artist or title -->
<!--
			<form id="form_search" method="POST">
-->
				<!-- identifier used by server: do not change or remove -->
				<input type="hidden" name="action" value="search" />
				<h1 id="search_songs">Liedje zoeken</h1>
				{% if search %}
					<input name="search" type="text" minlength="3" placeholder="Typ (deel van) naam van artiest of (deel van) titel" value="{{ search }}" />
				{% else %}
					<input name="search" type="text" minlength="3" placeholder="Typ (deel van) naam van artiest of (deel van) titel" />
				{% endif %}
				<div id="search_notification" class="notification">
					<!-- Will be filled by Javascript submitCredentials() -->
				</div>
				<button type="submit">Zoeken</button>
				<!-- Show songs found -->
				{% if search_songs %}
				<div class="file-list">
					<ul id="songs2">
					{% for song in search_songs %}
						<div style="display: grid; grid-template-columns: auto auto">
							<li id="{{ song["file"] }}">{{ song["artist"] }} - {{ song["title"] }}</li>
							<!-- Hide/show by Javascript depending on playlist -->
							<button class="songs my-button save-button2" title="Bewaren" onclick="addSong({{ song }})"></button>
						</div>
					{% endfor %}
					</ul>
				</div>
				{% endif %}
			</form>

		</div>

	</body>
	<script>
//const sleep = (delay) => new Promise((resolve) => setTimeout(resolve, delay));
		// Create custom select elements dropdown lists with options and actions
		document.querySelectorAll('.custom-select').forEach(container =>
		{
			const input = container.querySelector('input');
			const dropdown = container.querySelector('.options');
			const options = JSON.parse(container.dataset.options);

			function showOptions()
			{
				dropdown.innerHTML = '';
				options.forEach(option =>
				{
					const div = document.createElement('div');
					div.textContent = option;
					div.addEventListener('click', () =>
					{
						// Ignore if nothing changed
						if (input.value !== option)
						{
							// Update input with option
							input.value = option;

							// Hide dropdown with options
							dropdown.style.display = 'none';

							// preset changed
							if (input.id.includes("preset"))
								savepresets(input.id)

							// playlist changed
							if (input.id.includes("playlist"))
								// Submit to activate playlist
// In plaats van submit beter de lijst op te halen met een post?
								document.getElementById("form_playlist").submit();
console.log("playlist changed");
						}
						else
						console.log("Geen wijziging, dus niets doen");
					});
					dropdown.appendChild(div);
				});
				dropdown.style.display = 'block';
			}

			// Show options when input is clicked
			input.addEventListener("click", showOptions);

			// Show options when input gets focus
			input.addEventListener("focus", showOptions);

			// Hide options when input loses focus
			input.addEventListener("focusout", function (e)
			{
				// Delay to allow click on option to be processed
				setTimeout(() =>
				{
					if (!input.contains(document.activeElement))
					{
						dropdown.style.display = "none";
// In plaats van submit beter de lijst op te halen met een post?
//						document.getElementById("form_playlist").submit();
					}
				}, 200);
			});

			// Hide options when clicking outside the input or outside the options list
			document.addEventListener("click", function (e)
			{
				if (!container.contains(e.target))
				{
					dropdown.style.display = "none";
// In plaats van submit beter de lijst op te halen met een post?
//					document.getElementById("form_playlist").submit();
				}
			});

		});
	</script>

	<script>
		// Show buttons if playlist exist and is not a directory, otherwise hide button
		function buttonVisibility()
		{
			const songs = document.querySelectorAll(".songs");
			const playlist = document.getElementById("playlist").value;
			const directories = {{ directories|tojson|safe }};

			if (playlist && !directories.includes(playlist))
			{
				// Show buttons
				songs.forEach(el => {
					el.style.display = "block";
				});
			}
			else
			{
				// Hide buttons
				songs.forEach(el => {
					el.style.display = "none";
				});
			}
		}

		// Initialize
		buttonVisibility();

		// Update when playlist changes
		document.getElementById("playlist").addEventListener("change", function ()
		{
			buttonVisibility();
		});

		// Show the element used to trigger a server action
		location.hash = "#" + "{{ anchor }}";

		// Get notification element
		const presets_notification = document.getElementById('presets_notification');
		const playlist_notification = document.getElementById('playlist_notification');
		const search_notification = document.getElementById('search_notification');

//OMJ: Let op: als er door een POST een fout gevonden is verdwijnt die met onderstaande 3 instructies!
		// Clear old notifications
		presets_notification.innerHTML = "";
		playlist_notification.innerHTML = "";
		search_notification.innerHTML = "";

		// Notify if playlist and songs is empty
		const playlist = {{ playlist|tojson|safe }}
		const playlist_songs = {{ playlist_songs|tojson|safe }}
		if ((playlist.length > 0) && (playlist_songs.length === 0))
			playlist_notification.innerHTML = '<span class=\"warning\">Geen liedjes gevonden voor speellijst \'{{ playlist }}\'.</span>';

		// Notify if search and list is empty
		const search = {{ search|tojson|safe }}
		const search_songs = {{ search_songs|tojson|safe }}
		if ((search.length > 0) && (search_songs.length === 0))
			search_notification.innerHTML = '<span class=\"warning\">Geen liedjes gevonden met \'{{ search }}\' in de naam van de artiest of in de titel. Gebruik een andere zoekopdracht.</span>';

		// Catch user clicking a song
		if (ul = document.getElementById('songs1'))
		{
			ul.addEventListener('click', function(e)
			{
				if (e.target.tagName === 'LI')
				{
					event.preventDefault();

					// Send song to server for playback
					submitSong(e.target.id)
				}
			});
		}
		if (ul = document.getElementById('songs2'))
		{
			ul.addEventListener('click', function(e)
			{
				if (e.target.tagName === 'LI')
				{
					event.preventDefault();

					// Send song to server for playback
					submitSong(e.target.id)
				}
			});
		}

		// Function to submit the presets and changed preset
		async function savepresets(change)
		{
console.log("change=", change);
			// Send presets to server
			try
			{
				const response = await fetch('/save_presets', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
							"change": change,
							"list_1": document.getElementById("preset1").value,
							"list_2": document.getElementById("preset2").value,
							"list_3": document.getElementById("preset3").value
						})
				});

				if (! response.ok)
				{
					const errorData = await response.json();
					presets_notification.innerHTML = "<p class=\"error\">Error: "+ errorData + "</p>";
				}
				else
					presets_notification.innerHTML = "";

			}
			catch (error)
			{
				presets_notification.innerHTML = "<p class=\"error\">Er is een fout opgetreden bij het koppelen van de speellijst aan de knop.</p>";
			}
		}

		// Function to save the selected playlist
		function savePlaylist()
		{
			// Convert JinJa2 template variable to array
			const playlists = {{ playlists|tojson|safe }};
			const directories = {{ directories|tojson|safe }};
			const playlist = document.getElementById("playlist").value;

			// Only save if playlist does not yet exist
			if (!playlist || playlists.includes(playlist) || directories.includes(playlist))
			{
console.log("Geen actie, want geen speellijst ingevoerd of speellijst '" + playlist + "' bestaat al: TODO: +-knop niet tonen");
				return;
			}

			// Confirm creating the playlist
			if (confirm("Weet u zeker dat u speellijst '" + playlist + "' wilt bewaren?") == false)
				return;

			// Send playlist to save to server
			try
			{
				const response = fetch('/playlist_save', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ "name": playlist })
				});

				if (! response.ok)
				{
					const errorData = response.json();
					playlist_notification.innerHTML = "<p class=\"error\">Error: "+ errorData + "</p>";
				}
			}
			catch (error)
			{
				playlist_notification.innerHTML = "<p class=\"error\">Er is een fout opgetreden bij het bewaren van de speellijst.</p>";
			}

			// Submit form to reload
//			document.getElementById("form_playlist").submit();
		}

		// Function to delete the selected playlist
		function deletePlaylist()
		{
			// Convert JinJa2 template variable to array
			const playlists = {{ playlists|tojson|safe }};
			const directories = {{ directories|tojson|safe }};
			const playlist = document.getElementById("playlist").value;

			// Only delete if playlist exists
			if (!playlist || directories.includes(playlist) || !playlists.includes(playlist))
			{
console.log("Geen actie, want geen speellijst ingevoerd of speellijst '" + playlist + "' is beschermd of speellijst '" + playlist + "' bestaat niet: TODO: X-knop niet tonen");
				// Clear playlist input
				document.getElementById("playlist").value = "";

				return;
			}

			// Confirm deleting the playlist
			if (confirm("Weet u zeker dat u speellijst '" + playlist + "' wilt verwijderen?") == false)
				return;

			// Send playlist to delete to server
			try
			{
				const response = fetch('/playlist_delete', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ "name": playlist })
				});

				if (! response.ok)
				{
					const errorData = response.json();
					playlist_notification.innerHTML = "<p class=\"error\">Error: "+ errorData + "</p>";
				}
			}
			catch (error)
			{
				playlist_notification.innerHTML = "<p class=\"error\">Er is een fout opgetreden bij het verwijderen van de speellijst.</p>";
			}

			// Clear playlist input
			document.getElementById("playlist").value = "";

			// Submit form to reload
//			document.getElementById("form_playlist").submit();
		}

		async function addSong(song)
		{
			// Convert JinJa2 template variable to array
			const folders = {{ folders|tojson|safe }};
			const playlist = document.getElementById("playlist").value;

			// If playlist does not yet exist then ask for confirmation to create
			if (playlist && !folders.includes(playlist))
			{
				// Confirm creating the playlist with the song
				if (confirm("Weet u zeker dat u '" + song.title + "' van '" + song.artist + "' in de nieuwe speellijst '"  + playlist + "' wilt bewaren?") == false)
					return;
			}

			// Send song to add to playlist to server
			const errText = "Er is een fout opgetreden bij het toevoegen van '" + song.file + "' aan speellijst '" + playlist + "'";
			try
			{
				const response = await fetch('/playlist_add', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ "playlist": playlist, "song": song.file })
				});

				if (! response.ok)
				{
					const errorData = await response.json();
					playlist_notification.innerHTML = "<p class=\"error\">" + errText + " Error: " + errorData + "</p>";
				}
			}
			catch (error)
			{
				playlist_notification.innerHTML = "<p class=\"error\">" + errText + "</p>";
			}
		}

		async function removeSong(song)
		{
			// Send song to remove from playlist to server
			const playlist = document.getElementById("playlist").value;
			const errText = "Er is een fout opgetreden bij het verwijderen van '" + song + "' uit speellijst '" + playlist + "'";
			try
			{
				const response = await fetch('/playlist_remove', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ "playlist": playlist, "song": song.file })
				});

				if (! response.ok)
				{
					const errorData = response.json();
					playlist_notification.innerHTML = "<p class=\"error\">" + errText + " Error: " + errorData + "</p>";
				}
			}
			catch (error)
			{
				playlist_notification.innerHTML = "<p class=\"error\">" + errText + "</p>";
			}
		}

		// Function to submit the network and password
		async function submitSong(song)
		{
			// Send song to play to server
			try
			{
				const response = await fetch('/play_song', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ "song": song })
				});

				if (! response.ok)
				{
					if (playlist.length > 0)
						playlist_notification.innerHTML = "<p class=\"error\">Error: "+ response.json() + "</p>";
					if (search.length > 0)
						search_notification.innerHTML = "<p class=\"error\">Error: "+ response.json() + "</p>";
				}
			}
			catch (error)
			{
				if (playlist.length > 0)
					playlist_notification.innerHTML = "<p class=\"error\">Er is een fout opgetreden bij het indienen van het te spelen liedje.</p>";
				if (search.length > 0)
					search_notification.innerHTML = "<p class=\"error\">Er is een fout opgetreden bij het indienen van het te spelen liedje.</p>";
			}
		}
	</script>
</html>
