<!DOCTYPE html>
<html lang="nl">
	<head>
		<meta charset="UTF-8" />
		<meta name="autofocus" content="false">
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<link rel="stylesheet" href="../static/css/fontawesome.min.css" />
		<link rel="stylesheet" href="../static/css/regular.min.css" />
		<link rel="stylesheet" href="../static/css/oradio3.css" />
		<link rel="stylesheet" href="../static/css/playlists.css" />

		<title>Oradio speellijsten</title>

		<script>
			// Convert template variables to javascript
			var playlists = {{ playlists|tojson }};
			const directories = {{ directories|tojson }};

			// Global flag indicating playlist is protected
			let playlistProtected = true;

			// Function to submit the changed preset
			async function savepreset(preset)
			{
				// Set error template
				const errorMessage = `Koppelen van '${preset}' is mislukt`

				try
				{
					// Send presets to server
					const response = await fetch('/save_preset',
					{
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({"preset": preset, "playlist": document.getElementById(preset).value})
					});

					// Handle server response
					if (!response.ok)
					{
						const errorData = await response.json();
						playlist_notification.innerHTML = `<p class='error'>${errorData.message || errorMessage}</p>`;
						playlist_notification.style.display = "block";
					}
				}

				// Handle server not responding
				catch (error)
				{
					playlist_notification.innerHTML = `<p class='error'>${errorMessage} Controleer of de web interface actief is.</p>`;
					playlist_notification.style.display = "block";
				}
			}

			// Get songs for playlist input
			async function getPlaylistSongs()
			{
				// Clear and hide notification
				playlist_notification.innerHTML = "";
				playlist_notification.style.display = "none";

				// Get songs list container
				const songlist = document.getElementById("playlistsongs");

				// Hide songs list
				songlist.style.display = "none";

				// Get songs list element
				const ul = songlist.querySelector("ul");

				// Clear songs list
				ul.innerHTML = "";

				// Get playlist input
				const playlist = document.getElementById("playlist").value.trim();

				// Set error template
				const errorMessage = `Ophalen van de liedjes van speellijst '${playlist}' is mislukt.`;

				try
				{
					// Fetch playlist songs
					const response = await fetch('/get_playlist_songs',
					{
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({ "playlist": playlist })
					});

					// Handle server response
					if (response.ok)
					{
						// Wait for songs to be returned from server
						const songs = await response.json();

						// Get songs list container
						const songlist = document.getElementById("playlistsongs");

						// Hide songs list
						songlist.style.display = "none";

						// Get songs list element
						const ul = songlist.querySelector("ul");

						// Clear songs list
						ul.innerHTML = "";

						// Notify if no playlist is empty
						if (playlist && (songs.length === 0))
						{
							playlist_notification.innerHTML = `<span class='warning'>Speellijst '${playlist}' is leeg.</span>`;
							playlist_notification.style.display = "block";
							return;
						}

						// Notify if playlist is web radio
						if (songs.length && (/^https?:/.test(songs[0]['file'])))
						{
							playlist_notification.innerHTML = `<span class='warning'>Speellijst '${playlist}' is een webradio.</span>`;
							playlist_notification.style.display = "block";
							return;
						}

						// Finally, ok to manage playlist if not a directory
						if (!directories.includes(playlist))
							playlistProtected = false;

						// Render songs
						songs.forEach(song =>
						{
							// Create li element
							const li = document.createElement("li");
							// Song file name
							li.id = song.file;
							// Song artist and title
							li.textContent = `${song.artist} - ${song.title}`;
							// Add button if playlist is editable
							if (!playlistProtected)
							{
								// Create button element
								const button = document.createElement("button");
								// Readability
								button.title = "Verwijderen";
								// Styling
								button.classList.add("delete-button-small");
								// Add button element to li
								li.appendChild(button);
							}
							// Add li element to ul
							ul.appendChild(li);
						});

						// Show songs list
						songlist.style.display = "block";

						// Update search songs list if visible
						if (document.getElementById("searchsongs").style.display == "block")
							getSearchSongs();
					}
					else
					{
						const errorData = await response.json();
						playlist_notification.innerHTML = `<p class='error'>${errorData.message || errorMessage}</p>`;
						playlist_notification.style.display = "block";
					}
				}

				// Handle server not responding
				catch (error)
				{
					playlist_notification.innerHTML = `<p class='error'>${errorMessage} Controleer of de web interface actief is.</p>`;
					playlist_notification.style.display = "block";
				}
			}

			// Get songs for search input
			async function getSearchSongs()
			{
				// Clear and hide notification
				search_notification.innerHTML = "";
				search_notification.style.display = "none";

				// Get songs list container
				const songlist = document.getElementById("searchsongs");

				// Hide songs list
				songlist.style.display = "none";

				// Get songs list element
				const ul = songlist.querySelector("ul");

				// Clear songs list
				ul.innerHTML = "";

				// Get search input
				const search = document.getElementById("search").value.trim();

				// Check for minimal search length
				if (search.length < 3)
				{
					search_notification.innerHTML = `<span class='warning'>Gebruik een zoekopdracht met minimaal 3 karakters.</span>`;
					search_notification.style.display = "block";
					return;
				}

				// Set error template
				const errorMessage = `Ophalen van de liedjes voor '${search}' is mislukt.`;

				try
				{
					// Fetch search songs
					const response = await fetch('/get_search_songs',
					{
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({ "key": search })
					});

					// Handle server response
					if (response.ok)
					{
						// Wait for songs to be returned from server
						const songs = await response.json();

						// Get songs list container
						const songlist = document.getElementById("searchsongs");

						// Hide songs list
						songlist.style.display = "none";

						// Get songs list element
						const ul = songlist.querySelector("ul");

						// Clear songs list
						ul.innerHTML = "";

						// Notify if no search is empty
						if (search && (songs.length === 0))
						{
							search_notification.innerHTML = `<span class='warning'>Geen liedjes gevonden met '${search}' in de naam van de artiest of in de titel. Gebruik een andere zoekopdracht.</span>`;
							search_notification.style.display = "block";
							return;
						}

						// Render songs
						songs.forEach(song =>
						{
							// Create li element
							const li = document.createElement("li");
							// Song file name
							li.id = song.file;
							// Song artist and title
							li.textContent = `${song.artist} - ${song.title}`;
							// Add button if playlist is editable
							if (!playlistProtected)
							{
								// Create button element
								const button = document.createElement("button");
								// Readability
								button.title = "Toevoegen";
								// Styling
								button.classList.add("save-button-small");
								// Add button element to li
								li.appendChild(button);
							}
							// Add li element to ul
							ul.appendChild(li);
						});

						// Show songs list
						songlist.style.display = "block";
					}
					else
					{
						const errorData = await response.json();
						search_notification.innerHTML = `<p class='error'>${errorData.message || errorMessage}</p>`;
						search_notification.style.display = "block";
					}
				}

				// Handle server not responding
				catch (error)
				{
					search_notification.innerHTML = `<p class='error'>${errorMessage} Controleer of de web interface actief is.</p>`;
					search_notification.style.display = "block";
				}
			}

			// Add song to playlist. Create playlist if it does not exist.
			async function addSong(songfile)
			{
				// Get playlist
				const playlist = document.getElementById("playlist").value.trim();

				// playlist cannot be empty
				if (!playlist)
				{
					// Notify error
					playlist_notification.innerHTML = `<p class='error'>Kies of typ een geldige speellijstnaam.</p>`;
					playlist_notification.style.display = "block";

					// Hide songs list
					const songlist = document.getElementById("playlistsongs");
					songlist.style.display = "none";

					return;
				}

				// playlist cannot be a directory
				if (directories.includes(playlist))
				{
					// Notify error
					playlist_notification.innerHTML = `<p class='error'>Speellijst '${playlist}' is beschermd.<br>Typ een unieke speellijstnaam.</p>`;
					playlist_notification.style.display = "block";
					return;
				}

				const errorMessage = songfile
					? `Toevoegen van '${songfile}' aan speellijst '${playlist}' mislukt.`
					: `Opslaan van speellijst '${playlist}' mislukt`;

				await modifyPlaylist('Add', playlist, songfile, errorMessage);

				// Handle added song / added playlist
				if (!songfile)
					// Add playlist to playlists
					playlists.push(playlist);

				// Update songs list
				getPlaylistSongs();
			}

			// Remove song from playlist. Remove playlist if no song.
			async function removeSong(songfile)
			{
				// Get playlist
				const playlist = document.getElementById("playlist").value.trim();

				// playlist cannot be empty
				if (!playlist)
				{
					// Notify error
					playlist_notification.innerHTML = `<p class='error'>Kies of typ een geldige speellijstnaam.</p>`;
					playlist_notification.style.display = "block";

					// Hide songs list
					const songlist = document.getElementById("playlistsongs");
					songlist.style.display = "none";

					return;
				}

				// playlist cannot be a directory or web radio
				if (playlistProtected)
				{
					// Notify error
					playlist_notification.innerHTML = `<p class='error'>Speellijst '${playlist}' is beschermd,<br>kan daarom niet verwijderd worden.</p>`;
					playlist_notification.style.display = "block";

					// Hide songs list
					const songlist = document.getElementById("playlistsongs");
					songlist.style.display = "none";

					return;
				}

				// playlist must exist
				if (!playlists.includes(playlist))
				{
					// Notify error
					playlist_notification.innerHTML = `<p class='error'>Speellijst '${playlist}' bestaat niet.</p>`;
					playlist_notification.style.display = "block";

					// Hide songs list
					const songlist = document.getElementById("playlistsongs");
					songlist.style.display = "none";

					return;
				}

				// Set error template
				const errorMessage = songfile
					? `Verwijderen van '${songfile}' uit speellijst '${playlist}' mislukt.`
					: `Verwijderen van speellijst '${playlist}' mislukt.`;

				// Remove (song from) playlist from server
				await modifyPlaylist('Remove', playlist, songfile, errorMessage);

				// Handle removed song / removed playlist
				if (songfile)
				{
					// Update songs list
					getPlaylistSongs();
				}
				else
				{
					// Clear playlist input
					document.getElementById("playlist").value = "";

					// Remove playlist from playlists
					playlists = playlists.filter(pl => pl !== playlist);

					// Hide songs list
					const songlist = document.getElementById("playlistsongs");
					songlist.style.display = "none";
				}
			}

			// Send playlist and song to server
			async function modifyPlaylist(action, playlist, songfile, errorMessage)
			{
				try
				{
					// Submit action, playlist and song
					const response = await fetch('/playlist_modify',
					{
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({ "action": action, "playlist": playlist, "song": songfile ? songfile : "None" })
					});

					// Handle server response
					if (!response.ok)
					{
						const errorData = await response.json();
						playlist_notification.innerHTML = `<p class='error'>${errorData.message || errorMessage}</p>`;
						playlist_notification.style.display = "block";
					}
				}

				// Handle server not responding
				catch (error)
				{
					playlist_notification.innerHTML = `<p class='error'>${errorMessage} Controleer of de web interface actief is.</p>`;
					playlist_notification.style.display = "block";
				}
			}

			// Function to submit the song to the server for playback
			async function playSong(notification, songfile, songtitle)
			{
				// Set error template
				const errorMessage = `Er is een fout opgetreden bij het indienen van het te spelen liedje '${songtitle}'.`;

				try
				{
					// Submit song to play
					const response = await fetch('/play_song',
					{
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({ "song": songfile })
					});

					// Handle server response
					if (!response.ok)
					{
						const errorData = await response.json();
						notification.innerHTML = `<p class='error'>${errorData.message || errorMessage}</p>`;
						notification.style.display = "block";
					}
				}

				// Handle server not responding
				catch (error)
				{
					notification.innerHTML = `<p class='error'>${errorMessage} Controleer of de web interface actief is.</p>`;
					notification.style.display = "block";
				}
			}

			// Run when page is loaded
			document.addEventListener('DOMContentLoaded', function (event)
			{
				// Remove focus
				setTimeout(() =>
				{
					document.querySelectorAll('input').forEach(input =>
					{
						input.style.pointerEvents = 'auto';
					});
				}, 0);

				// Get the notification element once, reuse globally
				const presets_notification = document.getElementById('presets_notification');
				const playlist_notification = document.getElementById('playlist_notification');
				const search_notification = document.getElementById('search_notification');

				// Create custom select elements dropdown lists with options and actions
				document.querySelectorAll('.custom-select').forEach(container =>
				{
					const input = container.querySelector('input');
					const dropdown = container.querySelector('.options');

					function showOptions()
					{
						let options = directories.concat(playlists);
						options.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

						dropdown.innerHTML = '';
						options.forEach(option =>
						{
							const div = document.createElement('div');
							div.textContent = option;

							// Add click event handler
							div.addEventListener('click', (event) =>
							{
								// Cancel the default action that belongs to the event
								event.preventDefault();

								// Ignore if nothing changed
								if (input.value !== option)
								{
									// Update input with option
									input.value = option;

									// Hide dropdown with options
									dropdown.style.display = 'none';

									// Reset to protected
									playlistProtected = true;

									// Save changed preset
									if (input.id.includes("preset"))
										savepreset(input.id)

									// Fetch and parse playlist songs
									if (input.id.includes("playlist"))
										getPlaylistSongs();
								}
							});

							// Add option to list
							dropdown.appendChild(div);
						});

						// Show dropdown
						dropdown.style.display = 'block';
					}

					// Show options when input is clicked
					input.addEventListener("click", (event) =>
					{
						// Prevent click from propagating to document
						event.stopPropagation();

						// Show playlist dropdown
						showOptions();
					});

					// Hide options when input loses focus
					input.addEventListener("focusout", function (event)
					{
						// Cancel the default action that belongs to the event
						event.preventDefault();

						// Delay to allow click on option to be processed
						setTimeout(() =>
						{
							// Hide dropdown
							dropdown.style.display = "none";
						}, 300);
					});

					// Control what happens when the enter key is pressed in playlist input
					input.addEventListener("keydown", function (event)
					{
						// Check if Enter-key is pressed
						if (event.key === "Enter")
						{
							// Prevent default behavior
							event.preventDefault();

							// Hide dropdown
							dropdown.style.display = "none";

							// Get playlist input
							const playlist = input.value.trim();

							// Reset to protected
							playlistProtected = true;

							// Ignore if no playlist given
							if (!playlist) return;

							if (playlists.includes(playlist) || directories.includes(playlist))
							{
								// playlist exists: get playlist songs
								getPlaylistSongs();
							}
							else
							{
								// playlist does not exist: Notify user
								playlist_notification.innerHTML = `<p class='error'>Speellijst '${playlist}' bestaat niet.<br>Voeg toe met de <button class="save-button-tiny"></button>-knop.</p>`;
								playlist_notification.style.display = "block";

								// Hide songs list
								const songlist = document.getElementById("playlistsongs");
								songlist.style.display = "none";

								// Reset to protected
								playlistProtected = true;
							}
						}
					});
				});

				// Control what happens when the enter key is pressed in search input
				document.getElementById("search").addEventListener("keydown", function (event)
				{
					// Check if Enter-key is pressed
					if (event.key === "Enter")
					{
						// Prevent default behavior
						event.preventDefault();

						// Get songs for search key
						getSearchSongs();
					}
				});

				// Click handler for removing or playing song
				document.getElementById("playlistsongs").querySelector("ul").addEventListener("click", function(event)
				{
					// Get validated LI
					const li = event.target.closest("li");
					if (!li) return;

					if (event.target.matches("button"))
						// Delete button clicked
						removeSong(li.id);
					else
						// LI clicked
						playSong(playlist_notification, li.id, li.textContent);
				});

				// Click handler for adding or playing song
				document.getElementById("searchsongs").querySelector("ul").addEventListener("click", function(event)
				{
					// Get validated LI
					const li = event.target.closest("li");
					if (!li) return;

					if (event.target.matches("button"))
						// Add button clicked
						addSong(li.id);
					else
						// LI clicked
						playSong(search_notification, li.id, li.textContent);
				});

			});
		</script>

	</head>
	<body>
		{% include "menu.html" %}
		<div class="container">

			<!-- Show Oradio logo -->
			<img src="../static/logo.png" class="logo" />

			<!-- Link playlists to presets -->
			<h1 id="presets">Speellijst aan knop koppelen</h1>
			{% for preset in presets %}
				<div class="presets-grid">
					<div class="preset-label">
						Voorkeur {{ loop.index }}:
					</div>
					<div class="custom-select">
						<input type="text" id="{{ preset }}" name="{{ preset }}" value="{{ presets[preset] }}" readonly placeholder="-- Kies een speellijst --" />
						<span class="custom-icon">&#x25BC;</span> <!-- ▼ icon -->
						<div class="options"></div>
					</div>
				</div>
			{% endfor %}

			<!-- Show notifcations, if any -->
			<div id="presets_notification" class="notification">
				<!-- Will be filled by Javascript submitCredentials() -->
			</div>

			<!-- Manage playlists -->
			<h1 id="playlists">Speellijsten beheren</h1>
			<div class="playlists_grid">
				<div class="custom-select">
					<input type="text" id="playlist" name="playlist" placeholder="-- Kies een speellijst --" />
					<span class="custom-icon">&#x25BC;</span> <!-- ▼ icon -->
					<div id="options" class="options"></div>
				</div>
				<button class="save-button-large" title="Bewaren" onclick="addSong()"></button>
				<button class="delete-button-large" title="Verwijderen" onclick="removeSong()"></button>
			</div>

			<!-- Show notifcations, if any -->
			<div id="playlist_notification" class="notification">
				<!-- Will be filled by Javascript submitCredentials() -->
			</div>

			<!-- Show songs in a playlist -->
			<div id="playlistsongs" class="file-list">
				<ul class="songs">
				</ul>
			</div>

			<!-- Search songs by artist or title -->
			<h1 id="search_songs">Liedje zoeken</h1>
			<input style="margin: 0;" id="search" name="search" type="text" placeholder="Typ (deel van) naam van artiest of (deel van) titel" />
			<button type="text" title="Zoeken" onclick="getSearchSongs()">Zoeken</button>

			<!-- Show notifcations, if any -->
			<div id="search_notification" class="notification">
				<!-- Will be filled by Javascript submitCredentials() -->
			</div>

				<!-- Show songs found -->
			<div id="searchsongs" class="file-list">
				<ul class="songs">
				</ul>
			</div>

		</div>

	</body>
</html>
