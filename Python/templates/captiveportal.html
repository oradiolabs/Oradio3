<!DOCTYPE html>
<html lang="nl">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<!-- From OpenNDS splash page -->
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Expires" content="0">

		<link rel="stylesheet" href="../static/css/fontawesome.min.css" />
		<link rel="stylesheet" href="../static/css/regular.min.css" />
		<link rel="stylesheet" href="../static/css/oradio3.css" />
		<link rel="stylesheet" href="../static/css/captiveportal.css" />

		<title>Oradio wifi instellen</title>
	</head>
	<body>
		<div class="container">
			<h1 >Verbind met WiFi-netwerk</h1>

			<form>

				<label for="SSIDs">Netwerk:</label>
				<select id="SSIDs" onchange="networkSelected()">
					<option selected hidden disabled value="PLACEHOLDER">Selecteer uw WiFi-netwerk</option>
					{% for network in networks %}
						<option value="{{ network }}">{{ network }}</option>
					{% endfor %}
				</select>

				<div id="password">
					<label for="pswd">Wachtwoord:</label>
					<input id="pswd" class="pswd-input" type="password" placeholder="Voer WiFi-wachtwoord in" />
					<span class="password-toggle-icon oradio-eye"><i class="fa-regular fa-eye"></i></span>
				</div>

				<button type="submit" id="submit" onclick="submitCredentials()">Instellen</button>

				<div id="notification" class="notification">
					<!-- Will be filled by Javascript submitCredentials() -->
				</div>

			</form>

		</div>

	</body>

	<script>
		// Change form to reflect selected network
		function networkSelected()
		{
			// Clear notification
			document.getElementById('notification').innerHTML = "";
		}

		// Toggle password visibility
		const password = document.getElementById("pswd");
		const togglePassword = document.querySelector(".password-toggle-icon i");
		togglePassword.addEventListener("click", function ()
		{

			if (password.type === "password")
			{
				password.type = "text";
				togglePassword.classList.remove("fa-eye");
				togglePassword.classList.add("fa-eye-slash");
			}
			else
			{
				password.type = "password";
				togglePassword.classList.remove("fa-eye-slash");
				togglePassword.classList.add("fa-eye");
			}
		});

		// Function to submit the network and password
		async function submitCredentials()
		{
			event.preventDefault();

			// Get notification element
			const notification = document.getElementById('notification');

			// Clear old notification
			notification.innerHTML = "";

			// Get selected network info
			const ssid = document.getElementById("SSIDs").value;
			if (ssid == "PLACEHOLDER")
			{
				notification.innerHTML = "<div style=\"color: #ff0000;\">Kies een wifi netwerk</div>";
				return;
			}

			// Get password
			const pswd = document.getElementById("pswd").value;
			if (pswd.length <= 8)
			{
				notification.innerHTML = "<p style=\"color: #ff0000;\">Wachtwoord moet minimaal 8 karakters zijn</p>";
				return;
			}

			// Send credentials to server
			try
			{
				const response = await fetch('/wifi_connect', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ "ssid": ssid, "pswd": pswd })
				});

				if (response.ok)
				{
					notification.innerHTML = "<p>De huidige verbinding wordt verbroken.</p><p>Oradio probeert te verbinden met '" + ssid + "'</p>";
				}
				else
				{
					const errorData = await response.json();
					notification.textContent = "<p style=\"color: #ff0000;\">Error: "+ errorData + "</p>";
				}
			}
			catch (error)
			{
				notification.innerHTML = "<p style=\"color: #ff0000;\">Er is een fout opgetreden bij het indienen van de netwerkreferenties.</p>";
			}
		}
	</script>

</html>